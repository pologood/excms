!function(o){var t,e,n,r,a,i,s,u=null,c=null,l=!1,f=null,p={source:null,scriptNode:null},d="ssb",m="grs",g="sse",h={bufferSize:null,isSupport:!0},R={serverUrl:"/search/xfyy/getData",recordWorkerPath:null},v={init:function(){},onResult:function(e,t){},onVolume:function(){},onError:function(){},onProcess:function(e){}},S=function(){return!!navigator.getUserMedia&&(!!o.AudioContext&&(!!o.Worker&&!!o.URL))},U=(n=!1,r=e=t=0,a=function(){!n&&t<20?5<=++r&&(n=!0,v.onProcess("lowVolume")):(n&&20<=t&&v.onProcess("normalVolume"),20<=t&&(clearInterval(e),i(),r=0))},{start:i=function(){n=!1,r=t=0,e=setInterval(a,500)},stop:function(){clearInterval(e)},listen:function(e){t=Math.max(t,e)}}),M=function(e){c=e,p.source=u.createMediaStreamSource(e),p.scriptNode=u.createScriptProcessor(4096,1,1),f.init(u.sampleRate),p.scriptNode.onaudioprocess=function(e){if(l){var t=e.inputBuffer.getChannelData(0);f.sendData(t)}},p.source.connect(p.scriptNode),p.scriptNode.connect(u.destination),b.startRecord()},b={startRecord:function(){if(null==c)return function(){if(!navigator.getUserMedia)return v.onError.call(this,code,"当前浏览器不支持录音功能。");navigator.getUserMedia({audio:!0},M,function(e){var t=e.code||e.name;switch(t){case"PERMISSION_DENIED":case"PermissionDeniedError":v.onError.call(this,t,"用户拒绝提供信息。");break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":v.onError.call(this,t,"浏览器不支持硬件设备。");break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":v.onError.call(this,t,"无法发现指定的硬件设备。");break;default:v.onError.call(this,t,"无法打开麦克风。异常信息:"+(e.code||e.name))}}),null==u&&(u=new o.AudioContext)}(),void f.init();v.onProcess("onStart"),d,l=!0,U.start(),f.reset()},getResult:function(){s(),d&&v.onProcess("onStop"),m},stopRecord:s=function(){l=!1,U.stop()},abortSession:function(){s(),g}},w=function(e){var t=new Worker(e);t.onmessage=function(e){var t=e.data;if("end"==t.command)return v.onResult.call(this,function(e){if(!e)return!1;var t=new FormData;return t.append("audio",e),t.append("engineType","sms8k"),t.append("aue","raw"),$.ajax({url:R.serverUrl,type:"POST",data:t,processData:!1,contentType:!1})}(t.audio)),g,!1;U.listen(e.data.volume),v.onVolume.call(this,e.data.volume,t.buffer)};return{init:function(e){t.postMessage({command:"init",config:{inputSampleRate:e}})},reset:function(){t.postMessage({command:"reset"})},sendData:function(e){t.postMessage({command:"record",buffer:e})},getRecord:function(){t.postMessage({command:"getRecord"})}}};o.voiceWorker=function(e){var t=this;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,o.AudioContext=o.webkitAudioContext||o.AudioContext||o.mozAudioContext||o.msAudioContext,o.URL=o.URL||o.webkitURL,h.isSupport=S(),t.isSupport=function(){return h.isSupport},h.isSupport&&(v=$.extend(v,e.callback),(R=$.extend(R,e.params)).recordWorkerPath=o.URL.createObjectURL(new Blob(['var outputSampleRate,outputSampleBits,inputSampleRate,recBuffers=[],outputBufferLength=0,inputSampleBits=16;function reset(){recBuffers=[]}function init(t){inputSampleRate=t.inputSampleRate,outputSampleRate=t.outputSampleRate||7350,outputSampleBits=t.outputSampleBits||16}function record(t){recBuffers.push(new Float32Array(t)),outputBufferLength+=t.length;for(var e=0,a=Math.floor(t.length/10),n=0;n<a;n++)e+=Math.abs(t[10*n]);this.postMessage({buffer:t,volume:e})}function getRecord(){var t=encodeWAV();this.postMessage({command:"end",audio:t,bufferLen:outputBufferLength})}function compress(){for(var t=new Float32Array(outputBufferLength),e=0,a=0;a<recBuffers.length;a++)t.set(recBuffers[a],e),e+=recBuffers[a].length;for(var n=parseInt(inputSampleRate/outputSampleRate),r=t.length/n,u=new Float32Array(r),o=0,s=0;o<r;)u[o]=t[s],s+=n,o++;return u}function encodeWAV(){var t=Math.min(inputSampleRate,outputSampleRate),e=Math.min(inputSampleBits,outputSampleBits),a=compress(),n=a.length*(e/8),r=new ArrayBuffer(44+n),u=new DataView(r),o=0,s=function(t){for(var e=0;e<t.length;e++)u.setUint8(o+e,t.charCodeAt(e))};if(s("RIFF"),o+=4,u.setUint32(o,36+n,!0),o+=4,s("WAVE"),o+=4,s("fmt "),o+=4,u.setUint32(o,16,!0),o+=4,u.setUint16(o,1,!0),o+=2,u.setUint16(o,1,!0),o+=2,u.setUint32(o,t,!0),o+=4,u.setUint32(o,1*t*(e/8),!0),o+=4,u.setUint16(o,e/8*1,!0),o+=2,u.setUint16(o,e,!0),o+=2,s("data"),o+=4,u.setUint32(o,n,!0),o+=4,8===e)for(var i=0;i<a.length;i++,o++){var f=(p=Math.max(-1,Math.min(1,a[i])))<0?32768*p:32767*p;f=parseInt(255/(65535/(f+32768))),u.setInt8(o,f,!0)}else for(i=0;i<a.length;i++,o+=2){var p=Math.max(-1,Math.min(1,a[i]));u.setInt16(o,p<0?32768*p:32767*p,!0)}return new Blob([u],{type:"audio/wav"})}onmessage=function(t){var e=t.data;switch(e.command){case"init":init(e.config);break;case"record":record(e.buffer);break;case"getRecord":getRecord();break;case"reset":reset()}};'],{type:"text/javascript"})),t.recorderWorker=f=w(R.recordWorkerPath),t.start=function(){b.startRecord()},t.stop=function(){b.getResult()},t.cancel=function(){b.abortSession()},t.kill=function(){if(null!=c){for(var e=c.getAudioTracks(),t=0;t<e.length;t++)e[t].stop();c=null}null!=p.source&&(p.source.disconnect(),p.scriptNode.disconnect(),p.source=null,p.scriptNode=null)})}}(window);