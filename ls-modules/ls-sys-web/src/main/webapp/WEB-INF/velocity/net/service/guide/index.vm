

<div id="list_page" style="padding: 12px 20px 15px">
    <div class="table-toolbar">
        <div class="row">
            <div class="col-md-3">
                <div class="btn-group">
                    <button type="button" class="btn btn-default btn-add" onclick="addGuide()">添加</button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">批量操作<i
                        class="fa fa-angle-down"></i></button>
                    <ul class="dropdown-menu">
                        <li class="publishBtn"><a href="javascript:batchDel();">批量删除</a></li>
                        <li class="publishBtn"><a href="javascript:batchPublish();">批量发布</a></li>
                        <li class="publishBtn"><a href="javascript:batchCancelPublish();">批量取消发布</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-9">
                <form class="form-inline tr search-toolbar" role="form">
                    <div class="form-group">
                        <div class="input-group">
                            <div id="menuContent_ser"
                                 style="display:none; position: absolute; left: 0; top:34px; z-index: 10000; width: 212px; height: 300px; border: solid 1px #c2cad8; border-top:0px; overflow: auto; background-color: InactiveBorder">
                                <ul id="treeDemo_ser" class="ztree" style="margin-top:0;"></ul>
                            </div>
                            <input type="text" id="organId_ser" style="display: none" name="organId" disabled class="form-control readonly" ms-duplex="organId">
                            <input type="text" id="organName_ser" placeholder="单位" class="form-control readonly" readonly ms-duplex="organName" onclick="showSerTree()">

                            <div class="input-group-btn">
                                <button id="icon_btn" class="btn btn-default btn-select-organ" type="button" onclick="showSerTree()">
                                    <i class="fa fa-caret-down"></i>
                                </button>
                            </div>

                        </div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="ser_key" name="searchKey" class="form-control"
                               placeholder="标题">
                    </div>
                    <button type="button" class="btn btn-default btn-search" onclick="search()">
                        搜索
                    </button>
                    <button type="button" class="btn btn-default btn-show-all" onclick="showAll()">
                        显示全部
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div id="datagrid" class="mini-datagrid ls-mini-grid-cell" allowCellSelect="false" onlyCheckSelection="true" allowResize="true"
         url="/workGuide/getPageEOs" sizeList="[5,10,20,50]" pageSize="20" allowCellWrap="true"
         idField="id" multiSelect="true" showColumnsMenu="true" style="width:100%;"
    >
        <div property="columns">
            <div type="checkcolumn" width="50"></div>
            <div field="name" width="100%" align="left" headerAlign="center" renderer="goLink">文章标题</div>
            <div field="organName" width="160" align="center" align="center" headerAlign="center">单位名称</div>
            <div width="150" align="center" headerAlign="center" allowSort="true" renderer="joinDate">发布时间</div>
            <div width="50" align="center" headerAlign="center" renderer="guide_publish">发布</div>
            <div width="115" align="center" headerAlign="center" allowSort="true" renderer="opt">操作</div>
        </div>
    </div>
</div>
<div id="edit_page" style="display: none;">
    <div class="tabbable-line" style=" margin:12px 20px 15px;">
        <ul class="nav nav-tabs" id="myTab">
            <li class="active">
                <a href="#tab_1_1" data-toggle="tab"><strong>基本信息</strong></a>
            </li>
            <li>
                <a href="#tab_1_2" data-toggle="tab"><strong>附加信息</strong></a>
            </li>
        </ul>
        <div class="tab-content" style="padding: 0 0 0 0">
            <div class="tab-pane active" id="tab_1_1">
                <form id="guide_edit_form" role="form" ms-controller="guide_edit_form" style="padding-top: 15px">
                    <div class="form-body">
                        <table class="table table-bordered article-table">
                            <tr>
                                <th><font color="#9f9727">说明：</font></th>
                                <td>
                                    <font color="red">*代表必填项</font>
                                </td>
                            </tr>
                            <tr>
                                <th>事项名称(<font color="red">*</font>):</th>
                                <td>
                                    <input type="text" id="id" name="id" style="display: none" ms-duplex="id">
                                    <input type="text" id="contentId" name="contentId" style="display: none" ms-duplex="contentId">
                                    <input type="text" id="name" maxlength="260" name="name" class="form-control" data-rule="必填项:required;name" placeholder="填写事项名称" ms-duplex="name">
                                </td>
                            </tr>
                            <tr id="linkUrl" id="linkUrl">
                                <th>转向地址:</th>
                                <td>
                                    <div class="input-group">
                                                    <span class="input-group-addon">
                                                        <div class="checker"><span><input id="turnLink" name="turnLink" type="checkbox" ms-duplex-checked="turnLink"
                                                                                          onclick="turn_link()"></span></div> </span>
                                        <input type="text" name="linkUrl" class="form-control" placeholder="填写转向地址" ms-duplex="linkUrl">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>办事单位:</th>
                                <td>
                                    <div class="input-group">
                                        <div id="menuContent"
                                             style="display:none; position: absolute; top: 34px; left: 0px; z-index: 10000; width: 230px; height: 300px; border: solid 1px #c2cad8; border-top:0px; overflow:auto; background-color: InactiveBorder">
                                            <ul id="treeDemo" class="ztree" style="margin-top:0;"></ul>
                                        </div>

                                        <input type="text" id="organId" name="organId" style="display: none" name="organId" class="form-control readonly" readonly
                                               ms-duplex="organId">
                                        <input type="text" id="organName" name="organName" class="form-control readonly" readonly ms-duplex="organName" onclick="showTree()">

                                        <div class="input-group-btn">
                                            <button class="btn btn-default btn-select-organ" type="button" onclick="showTree()">
                                                <i class="fa fa-caret-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>加入时间:</th>
                                <td>
                                    <input type="text" id="joinDate" name="joinDate" class="form-control" data-rule="必填项:required;joinDate" placeholder="填写加入时间"
                                           ms-duplex="joinDate">
                                </td>
                            </tr>
                            <tr>
                                <td align="right">相关法规:</td>
                                <td>
                                    <textarea id="rule_select_lable" class="form-control" rows="2" onclick="rule_res_select()"
                                              placeholder="点击选择法规资源"></textarea>
                                </td>
                            </tr>

                            <tr>
                                <td valign="top" align="right">表格资源库:</td>
                                <td>
                                    <textarea id="table_select_lable" class="form-control" rows="2" onclick="table_res_select()"
                                              placeholder="点击选择表格资源"></textarea>
                                </td>
                                <td></td>
                            </tr>

                            <tr>
                                <td align="right">所属分类:</td>
                                <td>
                                    <input type="text" id="cIds" name="cIds" class="form-control" data-rule="必填项:required;cIds" style="display: none" ms-duplex="cIds">
                                    <textarea id="cNames" name="cNames" onclick="res_select()" class="form-control" rows="2" data-rule="必填项:required;cNames" placeholder="点击选择相关资源"
                                              ms-duplex="cNames"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <th></th>
                                <td>
                                    <label id="zx_ck_lb"><input type="checkbox" id="zx_ck" onclick="zx_link()"> 允许网民咨询  &nbsp;&nbsp;</label>
                                    <label id="ts_ck_lb"><input type="checkbox" id="ts_ck" onclick="ts_link()"> 允许网民投诉  &nbsp;&nbsp;</label>
                                    <label id="sb_ck_lb"><input type="checkbox" id="sb_ck" onclick="sb_link()"> 允许网民申报  &nbsp;&nbsp;</label>
                                    <label id="xccs_ck_lb"><input type="checkbox" id="xccs_ck" onclick="xccs_link()"> 最少去现场次数 </label>
                                </td>
                            </tr>
                            <tr id="zx_field">
                                <th>咨询链接:</th>
                                <td>
                                    <input type="text" name="zxLink" class="form-control" placeholder="填写转向地址" ms-duplex="zxLink">
                                </td>
                            </tr>
                            <tr id="ts_field">
                                <th>投诉链接:</th>
                                <td>
                                    <input type="text" name="tsLink" class="form-control" placeholder="填写转向地址" ms-duplex="tsLink">
                                </td>
                            </tr>
                            <tr id="sb_field">
                                <th>申报链接:</th>
                                <td>
                                    <input type="text" name="sbLink" class="form-control" placeholder="填写转向地址" ms-duplex="sbLink">
                                </td>
                            </tr>
                            <tr id="xccs_field">
                                <th>现场次数:</th>
                                <td>
                                    <input type="text" name="minLocalTime" class="form-control" placeholder="最少去现场次数" ms-duplex="minLocalTime">
                                </td>
                            </tr>
                            <tr id="content_field">
                                <td align="right">其他:</td>
                                <td>
                                    <textarea id="content" name="content" style="width: 100%;height: 300px;" ms-duplex="content"></textarea>
                                </td>
                            </tr>
                            #if($!{toolbar} != 'hide')
                            <tr id="content_field">
                                <th></th>
                                <td>
                                    <button type="button" class="btn btn-default btn-save-release" onclick="saveData(1)">保存并发布</button>
                                    <button type="button" class="btn btn-default btn-save" onclick="saveData()">保 存</button>
                                    <button type="button" class="btn btn-default btn-back" onclick="cancel()">返 回</button
                                </td>
                            </tr>
                            #end
                        </table>
                    </div>
                </form>
            </div>
            <div class="tab-pane" id="tab_1_2">
                <form id="guide_attach_form" role="form" style="padding-top: 15px">
                    <div class="form-body">
                        <table class="table table-bordered article-table">
                            <tr>
                                <td valign="top" align="right">设定依据(<font color="red">*</font>):</td>
                                <td>
                                    <textarea id="setAccord" name="setAccord" data-rule="必填项:required;setAccord" ms-duplex="setAccord" style="width: 100%;height: 300px;"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td align="right">申请条件(<font color="red">*</font>):</td>
                                <td>
                                    <textarea id="applyCondition" name="applyCondition" ms-duplex="applyCondition" style="width: 100%;height: 300px;"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td align="right">办理材料(<font color="red">*</font>):</td>
                                <td>
                                    <textarea id="handleData" name="handleData" ms-duplex="handleData" style="width: 100%;height: 300px;"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td align="right">办理流程(<font color="red">*</font>):</td>
                                <td>
                                    <textarea id="handleProcess" name="handleProcess" ms-duplex="handleProcess" style="width: 100%;height: 300px;"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <th>办理地址(<font color="red">*</font>):</th>
                                <td>
                                    <input type="text" id="handleAddress" maxlength="1200" name="handleAddress" class="form-control" placeholder="办理地址" ms-duplex="handleAddress">
                                </td>
                            </tr>
                            <tr>
                                <th>办理时间(<font color="red">*</font>):</th>
                                <td>
                                    <input type="text" id="handleDate" maxlength="1200" name="handleDate" class="form-control" placeholder="办理时间" ms-duplex="handleDate">
                                </td>
                            </tr>
                            <tr>
                                <th>办理时限(<font color="red">*</font>):</th>
                                <td>
                                    <input type="text" id="handleLimit" name="handleLimit" maxlength="1200" class="form-control" placeholder="办理时限" ms-duplex="handleLimit">
                                </td>
                            </tr>
                            <tr>
                                <th>收费标准(<font color="red">*</font>):</th>
                                <td>
                                    <input type="text" id="feeStandard" name="feeStandard" maxlength="1200" class="form-control" placeholder="收费标准" ms-duplex="feeStandard">
                                </td>
                            </tr>
                            <tr>
                                <th>联系电话(<font color="red">*</font>):</th>
                                <td>
                                    <input type="text" id="phone" name="phone" maxlength="600" class="form-control" placeholder="联系电话" ms-duplex="phone">
                                </td>
                            </tr>
                            #if($!{toolbar} != 'hide')
                                <tr>
                                    <th></th>
                                    <td>
                                        <button type="button" class="btn btn-default btn-save-release" onclick="saveData(1)">保存并发布</button>
                                        <button type="button" class="btn btn-default btn-save" onclick="saveData()">保 存</button>
                                        <button type="button" class="btn btn-default btn-back" onclick="cancel()">返 回</button>
                                    </td>
                                </tr>
                            #end
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="$!{rc.contextPath}/assets/js/pages/net/service/organ_tree.js"></script>
<script src="$!{rc.contextPath}/assets/js/pages/net/service/organ_tree_ser.js"></script>
<script>
    mini.parse();
    var cur = {
        vm_id: "guide_edit_form",
        form: $('#guide_edit_form'),
        list_page: $('#list_page'),
        edit_page: $('#edit_page'),
        grid: mini.get('datagrid'),
        content: $("#content"), //具体内容
        content_field: $("#content_field"),//可隐藏组件
        organId_ser: $('#organId_ser'),//查询部门选择组件
        organName_ser: $('#organName_ser'),//查询部门选择组件
        organId: $('#organId'),//添加修改部门选择组件
        organName: $('#organName'),//添加修改部门选择组件
        ser_key: $('#ser_key'),//查询关键字
        linkUrl: $('#linkUrl'),//链接地址组件
        zx_ck: $('#zx_ck'),
        ts_ck: $('#ts_ck'),
        sb_ck: $('#sb_ck'),
        xccs_ck: $('#xccs_ck'),
        zx_ck_lb: $('#zx_ck_lb'),
        ts_ck_lb: $('#ts_ck_lb'),
        sb_ck_lb: $('#sb_ck_lb'),
        xccs_ck_lb: $('#xccs_ck_lb'),
        zx_field: $('#zx_field'),
        ts_field: $('#ts_field'),
        sb_field: $('#sb_field'),
        xccs_field: $('#xccs_field'),
        table_select_lable:$('#table_select_lable'),
        rule_select_lable: $('#rule_select_lable'),
        cIds: $('#cIds'),
        cNames: $('#cNames'),
        handleAddress: $('#handleAddress'),
        handleDate: $('#handleDate'),
        phone: $('#phone'),
        handleLimit:$('#handleLimit'),
        feeStandard:$('#feeStandard'),
        links:{}
    };
    /**
     * 初始化加载
     */
    $(document).ready(function () {
        //初始化文本编辑器
        initKindEditor();

//        cur.linkUrl.hide();

        //初始化表格高度
        Ls.mini_datagrid_height(cur.grid, 30);

        cur.grid.load({classifyId: content_mgr.indicatorId});
        getLinks(content_mgr.indicatorId);

        //初始化vm
        cur.model = Ls.initFORM(cur.vm_id, {
            id: null,
            turnLink: false,
            cIds: "",
            cNames: ""
        });
        setData(cur.model);

        cur.grid.on("beforeselect", function (e) {
            var disabledStr = Ls.publishStatus(e.record.publish);
            if (disabledStr) {
                e.cancel = true
            }
        });

        organ_select_tree_ser.init();
        if('$!{toolbar}' == 'hide') {
            editGuideByContent();
        }
    })

    /**
     * 添加法规
     */
    function addGuide() {
        organ_select_tree.init();
        /*if(GLOBAL_RIGHTS == "normal") {
        }*/
        cur.type = 'add';
        //基本信息重置
        base_info_reset();

        //初始化vm
        cur.model = Ls.initFORM(cur.vm_id, {
            id: null,
            turnLink: false
        });

        //分类管理初始化
        set_classify_info();

        //附加信息重置
        attach_info_reset();

        zx_link();
        ts_link();
        sb_link();
        xccs_link();

        cur.cIds.val(content_mgr.node.indicatorId);
        cur.cNames.val(content_mgr.node.name);
        cur.list_page.hide();
        cur.edit_page.show();

        if(!isNull(cur.links.consoleLink)) {
            cur.zx_ck.attr("checked", "checked");
            cur.vm.zxLink = cur.links.consoleLink;
            cur.zx_field.show();
        }

        if(!isNull(cur.links.complaintLink)) {
            cur.ts_ck.attr("checked", "checked");
            cur.vm.tsLink = cur.links.complaintLink;
            cur.ts_field.show();
        }

        if(!isNull(cur.links.declarationLink)) {
            cur.sb_ck.attr("checked", "checked");
            cur.vm.sbLink = cur.links.declarationLink;
            cur.sb_field.show();
        }

        if(!isNull(cur.links.visitCount)) {
            cur.xccs_ck.attr("checked", "checked");
            cur.vm.minLocalTime = cur.links.visitCount;
            cur.xccs_field.show();
        }
        selectNode(GLOBAL_PERSON.unitId,GLOBAL_PERSON.unitName);
    }

    function selectNode(recUnitId,recUnitName) {
        var id = $("#organId");
        var name = $("#organName");
        id.val(recUnitId);
        name.val(recUnitName);
    }

    function base_info_reset() {
        var ids = ['id', 'name', 'linkUrl', 'organId', 'zxLink', 'tsLink', 'sbLink', 'joinDate', 'handleAddress', 'handleDate', 'phone','handleLimit','feeStandard'];
        form_reset(ids);
        $('#joinDate').val(new Date().pattern("yyyy-MM-dd HH:mm:ss"));
        //cur.editor_content.html('');
	cur.editor_content.setHtml('');

        //表格资源库设置
        cur.table_select_lable.text('');
        cur.table_select_lable.attr('value','');

        //法规资源库设置
        cur.rule_select_lable.text('');
        cur.rule_select_lable.attr('value', '');

        //分类资源库设置
        cur.cIds.val('');
        cur.cNames.val('');
    }

    function attach_info_reset() {
        var ids = ['handleAddress', 'handleDate', 'phone','handleLimit','feeStandard'];
        form_reset(ids);
        //$('#handleDate').val(new Date().pattern("yyyy-MM-dd hh:mm:ss"));
        /*cur.editor_set_accord.html('');
        cur.editor_apply_condition.html('');
        cur.editor_handle_data.html('');
        cur.editor_handle_process.html('');*/
	cur.editor_set_accord.setHtml('');
        cur.editor_apply_condition.setHtml('');
        cur.editor_handle_data.setHtml('');
        cur.editor_handle_process.setHtml('');
    }

    /**
     * 编辑事项
     */
    function editGuide(id) {
        organ_select_tree.init();
        cur.record = cur.grid.findRow(function (row) {
            if (row.id == id) return true;
        });
        cur.model = cur.record;
        cur.type = 'edit';

        zx_link();
        ts_link();
        sb_link();
        xccs_link();

        //设置基本数据
        set_base_info();

        //设置分类树
        set_classify_info();

        //设置附加内容
        set_attach_info();

        set_classify();

        cur.list_page.hide();
        cur.edit_page.show();
    }

    function getLinks(columnId) {
        Ls.ajaxGet({
            url: "/workGuide/getLinks",
            data: {
                columnId: columnId
            },
            success: function (resp) {
                if(resp.status == 1) {
                    cur.links = resp.data;
                    if(cur.links.isConsole == 0) {
                        cur.zx_ck_lb.hide();
                    }

                    if(cur.links.isComplaint == 0) {
                        cur.ts_ck_lb.hide();
                    }

                    if(cur.links.isDeclaration == 0) {
                        cur.sb_ck_lb.hide();
                    }

                    if(cur.links.isVisit == 0) {
                        cur.xccs_ck_lb.hide();
                    }
                }
            }
        });
    }

    function set_classify() {
        Ls.ajaxGet({
            url: "/resources/getCheckedClassifyEOs",
            data: {
                pId: cur.model.id,
                typeCode: '$!{typeCode}'
            },
            success: function (resp) {
                if (resp.status == '1') {
                    var data = resp.data;
                    var cIds = "";
                    var cNames = "";

                    for (var i = 0; i < data.length; i++) {
                        if (i == 0) {
                            cIds = data[i].indicatorId;
                            cNames = data[i].name;
                        } else {
                            cIds += "," + data[i].indicatorId;
                            cNames += "," + data[i].name;
                        }
                        cur.vm.cIds = cIds;
                        cur.vm.cNames = cNames;
                        avalon.scan();
                    }
                }
            }
        });
    }

    function set_base_info() {
        Ls.assignVM(cur.vm, cur.model);
        avalon.scan();

        //cur.editor_content.html(cur.vm.content);
	cur.editor_content.setHtml(cur.vm.content);
        //转链设置
        if (cur.model.turnLink == 'true') {
            linkUrl_show();
            cur.vm.turnLink = true;
        } else {
            content_show();
            cur.vm.turnLink = false;
        }

        cur.organId.val(cur.model.organId);
        cur.organName.val(cur.model.organName);

        //表格资源库设置
        cur.table_select_lable.text(cur.record.tableNames == null?'':cur.record.tableNames);
        cur.table_select_lable.attr('value',cur.record.tableIds);

        //法规资源库设置
        cur.rule_select_lable.text(cur.record.ruleNames == null ? '' : cur.record.ruleNames);
        cur.rule_select_lable.attr('value', cur.record.ruleIds);

        //分类资源库设置
        cur.cIds.val('');
        cur.cNames.val('');

        //我要咨询设置
        if (cur.model.zxLink != null) {
            cur.zx_ck.attr("checked", "checked");
            zx_link();
        }

        //我要投诉设置
        if (cur.model.tsLink != null) {
            cur.ts_ck.attr("checked", "checked");
            ts_link();
        }

        //我要申报设置
        if (cur.model.sbLink != null) {
            cur.sb_ck.attr("checked", "checked");
            sb_link();
        }

        if (cur.model.minLocalTime != null) {
            cur.xccs_ck.attr("checked", "checked");
            xccs_link();
        }
    }

    function set_classify_info() {
        //分类树
    }

    function set_attach_info() {
        /*cur.editor_set_accord.html(cur.model.setAccord);
        cur.editor_apply_condition.html(cur.model.applyCondition);
        cur.editor_handle_data.html(cur.model.handleData);
        cur.editor_handle_process.html(cur.model.handleProcess);*/
	cur.editor_set_accord.setHtml(cur.model.setAccord);
        cur.editor_apply_condition.setHtml(cur.model.applyCondition);
        cur.editor_handle_data.setHtml(cur.model.handleData);
        cur.editor_handle_process.setHtml(cur.model.handleProcess);
        cur.handleAddress.val(cur.model.handleAddress);
        cur.handleDate.val(cur.model.handleDate);
        cur.phone.val(cur.model.phone);
        cur.handleLimit.val(cur.model.handleLimit);
        cur.feeStandard.val(cur.model.feeStandard);
    }

    //拉取数据
    function setData(obj) {
        cur.vm = avalon.vmodels[cur.vm_id];
        data = obj;
        if (cur.vm) {
            Ls.assignVM(cur.vm, data);
        } else {
            data.vm_id = cur.vm_id;
            cur.vm = avalon.define(data);
        }
        avalon.scan($("#" + cur.vm_id).get(0), cur.vm);
    }

    /**
     * 保存数据
     */
    function saveData(publish) {
        if ($('#turnLink').prop("checked")) {
            cur.vm.content = null;
        } else {
            cur.vm.linkUrl = null;
        }

        if (!cur.form.isValid()) {
            return;
        }

        if (cur.type == 'add') {
            url = "/workGuide/saveEO"
        } else {
            url = "/workGuide/updateEO"
        }

        if (!cur.zx_ck.prop("checked") || cur.links.isConsole == 0) {
            cur.vm.zxLink = "";
        }

        if (!cur.ts_ck.prop("checked") || cur.links.isComplaint == 0) {
            cur.vm.tsLink = "";
        }

        if (!cur.sb_ck.prop("checked") || cur.links.isDeclaration == 0) {
            cur.vm.sbLink = "";
        }

        if (!cur.xccs_ck.prop("checked") || cur.links.isVisit == 0) {
            cur.vm.minLocalTime = "";
        }

        //if(cur.editor_set_accord.html() == "") {
	if (cur.editor_set_accord.getHtml() == "") {
            Ls.tips("设定依据不能为空", {times: 2,icons:"error"});
            return;
        }
        //if(cur.editor_apply_condition.html() == "") {
	if (cur.editor_apply_condition.getHtml() == "") {
            Ls.tips("申请条件不能为空", {times: 2,icons:"error"});
            return;
        }
        //if(cur.editor_handle_data.html() == "") {
	if (cur.editor_handle_data.getHtml() == "") {
            Ls.tips("办理材料不能为空", {times: 2,icons:"error"});
            return;
        }
        //if(cur.editor_handle_process.html() == "") {
	if (cur.editor_handle_process.getHtml() == "") {
            Ls.tips("办理流程不能为空", {times: 2,icons:"error"});
            return;
        }
        if(cur.handleAddress.val() == "") {
            Ls.tips("办理地址不能为空", {times: 2,icons:"error"});
            return;
        }
        if(cur.handleDate.val() == "") {
            Ls.tips("办理时间不能为空", {times: 2,icons:"error"});
            return;
        }
        if(cur.handleLimit.val() == "") {
            Ls.tips("办理时限不能为空", {times: 2,icons:"error"});
            return;
        }
        if(cur.feeStandard.val() == "") {
            Ls.tips("收费标准不能为空", {times: 2,icons:"error"});
            return;
        }
        if(cur.phone.val() == "") {
            Ls.tips("联系电话不能为空", {times: 2,icons:"error"});
            return;
        }

        // 更新所有编辑器内容到 textarea
        EWEBEDITOR.UpdateAll();
        Ls.ajax({
            url: url,
            data: {
                id: cur.vm.id,
                name: cur.vm.name,
                linkUrl: cur.vm.linkUrl,
                organId: cur.organId.val(),
                joinDate: cur.vm.joinDate,
                //content: cur.editor_content.html(),
		        content: cur.editor_content.getHtml(),
                turnLink: cur.vm.turnLink,
                zxLink: cur.vm.zxLink,
                tsLink: cur.vm.tsLink,
                sbLink: cur.vm.sbLink,
                minLocalTime:cur.vm.minLocalTime,
                cIds: cur.vm.cIds,
                columnId: content_mgr.indicatorId,
                contentId: cur.vm.contentId,
                typeCode: content_mgr.node.columnTypeCode,
                tableIds:cur.table_select_lable.attr('value'),
                ruleIds: cur.rule_select_lable.attr('value'),
                /*setAccord: cur.editor_set_accord.html(),
                applyCondition: cur.editor_apply_condition.html(),
                handleData: cur.editor_handle_data.html(),
                handleProcess: cur.editor_handle_process.html(),*/
		        setAccord: cur.editor_set_accord.getHtml(),
                applyCondition: cur.editor_apply_condition.getHtml(),
                handleData: cur.editor_handle_data.getHtml(),
                handleProcess: cur.editor_handle_process.getHtml(),
                handleAddress: cur.handleAddress.val(),
                handleDate: cur.handleDate.val(),
                phone: cur.phone.val(),
                handleLimit:cur.handleLimit.val(),
                feeStandard:cur.feeStandard.val(),
                publish: publish == null || publish == '' ? 0 : 1
            },
            success: function (resp) {
                if (resp.status == '1') {
                    Ls.tips(resp.desc, {times: 2});
                    cur.list_page.show();
                    cur.edit_page.hide();
                    search();
                } else {
                    Ls.tips(resp.desc, {icons:'error',times: 2});
                }
            }
        });
    }

    function delGuide(id) {
        if (confirm('确定删除?')) {
            Ls.ajaxGet({
                url: "/workGuide/delete",
                data: {
                    ids: id
                },
                success: function (resp) {
                    if (resp.status == 1) {
                        search();
                        Ls.tips("删除完成，正在生成处理中", {times: 2});
                    } else {
                        Ls.tips(resp.desc, {icons:'error',times: 2});
                    }
                }
            });
        }
        ;
    }

    function batchDel() {
        var records = cur.grid.getSelecteds();

        if (null == records || records.length <= 0) {
            Ls.tips("请选择一条记录!", {times: 2});
            return;
        }

        var ids = [];
        for (var i = 0; i < records.length; i++) {
            ids.push(records[i].id);
        }

        if (confirm('确定删除?')) {
            Ls.ajaxGet({
                url: "/workGuide/delete",
                data: {
                    ids: ids.join(",")
                },
                success: function (resp) {
                    if (resp.status == 1) {
                        showAll();
                        Ls.tips("批量删除完成，正在生成处理中", {times: 2});
                    } else {
                        Ls.tips(resp.desc, {icons:'error',times: 2});
                    }
                }
            });
        }
    }

    function guide_name(obj) {
        var record = obj.record;
        var diyDom = '<a href="' + formate_url(record.linkUrl) + '" target="_black" ><u>' + record.name + '</u></a>';
        return diyDom;
    }

    function joinDate(obj) {
        if('$!{toolbar}' != 'hide') {
            var record = obj.record;
            var joinDate = record.joinDate;
            var handleDate = record.handleDate;

            if (null != handleDate && typeof handleDate == 'object') {
                record.handleDate = handleDate.pattern("yyyy-MM-dd HH:mm:ss");
            }

            if (null != joinDate && typeof joinDate == 'object') {
                record.joinDate = joinDate.pattern("yyyy-MM-dd HH:mm:ss");
                return joinDate.pattern("yyyy-MM-dd HH:mm:ss");
            } else {
                return joinDate;
            }
        }
    }

    /*function opt(obj) {
        var record = obj.record;
        var diyDom = '<button type="button" class="btn btn-default btn-sm btn-edit" onclick="editGuide(' + record.id + ')">修 改</button> ' +
            '<button type="button" class="btn btn-default btn-sm btn-delete" onclick="delGuide(' + record.id + ')">删 除</button>';
        return diyDom;
    }*/
    function opt(e) {
        /*var record = obj.record;
        var diyDom = '<button type="button" class="btn btn-default btn-sm btn-edit" onclick="editGuide(' + record.id + ')">修 改</button> ' +
            '<button type="button" class="btn btn-default btn-sm btn-delete" onclick="delGuide(' + record.id + ')">删 除</button>';*/

        var rec = e.record, editStr = ''
        var disabledStr = Ls.publishStatus(rec.publish);
        var publishStr='';
        if(rec.publish=='1'){
            publishStr='<li><a href="javascript:void(0)" onclick="publish('+ rec.id +')">重新发布</a></li>' ;
        }
        var editStr =
                '<div class="btn-group" role="group">' +
                '   <button ' + disabledStr + ' type="button" class="btn btn-default btn-sm" onclick="editGuide(' + rec.id + ')">修 改</button> '+
                '   <button ' + disabledStr + ' type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">' +
                '       <i class="fa fa-angle-down"></i>' +
                '   </button>' +
                '   <ul class="dropdown-menu pull-right">' +publishStr+
                '       <li><a href="javascript:void(0)" onclick="delGuide(' + rec.id + ')">删 除</a></li>' +
                '   </ul>' +
                '</div>';

        return editStr;
    }

    /*function goLink(e) {
        var rec = e.record
        var str = "";
        return str = '<a target="_blank" href="' + GLOBAL_HTMLFILEPATH + '/content/article/' + rec.contentId +'?guideId=' + rec.id + '"><u>' + rec.name  + '</u></a>';
    }*/

    function goLink(e) {
        var rec = e.record,str = '';
        str = '<a target="_blank" href="' + GLOBAL_HTMLFILEPATH + '/content/article/' + rec.contentId +'?guideId=' + rec.id + '"><u>' + rec.name  + '</u></a>';
        str += '<span id="publish_' + rec.contentId + '" class="publish-status">';
        var status = Ls.publishStatus(rec.publish);
        if (status != "") {
            str += '[生成中...]';
        }
        str += '</span>';
        return str;
    }

    function search() {
        var keyValue = cur.ser_key.val();
        cur.grid.load({pageIndex:cur.grid.pageIndex,pageSize:cur.grid.pageSize,classifyId: content_mgr.indicatorId, keys: 'name', keyValue: keyValue, organId: cur.organId_ser.val()});
    }

    function showAll() {
        cur.ser_key.val('');
        cur.organId_ser.val('');
        cur.organName_ser.val('');
        cur.organId.val('');
        cur.organName.val('');
        search();
    }

    function file_download() {
        var record = cur.grid.getSelected();
        $("#download_frame").attr("src", "$!{rc.contextPath}/fileCenter/download/" + record.uploadUrl);
    }

    function initKindEditor() {
        /*var setting = {
            uploadJson: GLOBAL_CONTEXTPATH + '/articleNews/upload?siteId=' + GLOBAL_SITEID + "&columnId=" + content_mgr.indicatorId,//上传文件
            fileManagerJson: '/fileCenter/getPage',//文件空间
            allowImageUpload: true,
            allowFileManager: false,
            allowFlashUpload: false,
            allowMediaUpload: false,
            filterMode: false,
            siteId: GLOBAL_SITEID,
            columnId: content_mgr.indicatorId,
            fileServerPath: GLOBAL_FILESERVERNAMEPATH,
            afterCreate: function () {
                this.sync();
            },
            afterBlur: function () {
                this.sync();
            },
            resizeType: 1
        };
        cur.editor_content = KindEditor.create('textarea[name="content"]', setting);

        cur.editor_set_accord = KindEditor.create('textarea[name="setAccord"]', setting);

        cur.editor_apply_condition = KindEditor.create('textarea[name="applyCondition"]', setting);

        cur.editor_handle_data = KindEditor.create('textarea[name="handleData"]', setting);

        cur.editor_handle_process = KindEditor.create('textarea[name="handleProcess"]', setting);*/

        //创建ewebeditor
        cur.editor_content = Ls.editor("content", {
            cusdir: "/" + GLOBAL_SITEID + "/" + content_mgr.indicatorId
        });

        //创建ewebeditor
        cur.editor_set_accord = Ls.editor("setAccord", {
            cusdir: "/" + GLOBAL_SITEID + "/" + content_mgr.indicatorId
        });

        //创建ewebeditor
        cur.editor_apply_condition = Ls.editor("applyCondition", {
            cusdir: "/" + GLOBAL_SITEID + "/" + content_mgr.indicatorId
        });

        //创建ewebeditor
        cur.editor_handle_data = Ls.editor("handleData", {
            cusdir: "/" + GLOBAL_SITEID + "/" + content_mgr.indicatorId
        });

        //创建ewebeditor
        cur.editor_handle_process = Ls.editor("handleProcess", {
            cusdir: "/" + GLOBAL_SITEID + "/" + content_mgr.indicatorId
        });

    }

    function cancel() {
        $('#myTab a:first').tab('show');
        cur.list_page.show();
        cur.edit_page.hide();
        showAll();
    }

    function zx_link() {
        if (cur.zx_ck.prop("checked")) {
            cur.zx_field.show();
            if(isNull(cur.vm.zxLink)) {
                cur.vm.zxLink = cur.links.consoleLink;
                avalon.scan();
            }
        } else {
            cur.zx_field.hide();
        }
    }

    function ts_link() {
        if (cur.ts_ck.prop("checked")) {
            cur.ts_field.show();
            if(isNull(cur.vm.tsLink)) {
                cur.vm.tsLink = cur.links.complaintLink;
                avalon.scan();
            }
        } else {
            cur.ts_field.hide();
        }
    }

    function sb_link() {
        if (cur.sb_ck.prop("checked")) {
            cur.sb_field.show();
            if(isNull(cur.vm.sbLink)) {
                cur.vm.sbLink = cur.links.declarationLink;
                avalon.scan();
            }
        } else {
            cur.sb_field.hide();
        }
    }

    function xccs_link() {
        if (cur.xccs_ck.prop("checked")) {
            cur.xccs_field.show();
            if(isNull(cur.vm.minLocalTime)) {
                cur.vm.minLocalTime = cur.links.visitCount;
                avalon.scan();
            }
        } else {
            cur.xccs_field.hide();
        }
    }

    function isNull(obj) {
        return obj == null || obj == "" || obj == "null";
    }

    function turn_link() {
        if ($('#turnLink').prop("checked")) {
            linkUrl_show();
        } else {
            content_show();
        }
    }

    function linkUrl_show() {
        cur.content_field.hide();
    }

    function content_show() {
        cur.content_field.show();
    }

    /**
     * 发布法规
     */
   /* function guide_publish(obj) {
        var record = obj.record;
        var diyDom = '<a id=' + record.id + ' onclick="publish(this)"><img src="$!{rc.contextPath}assets/images/noclick.gif" border="0" title="发布" ></a>';
        if (record.publish == 1) {
            diyDom = '<a id=' + record.id + ' onclick="cancel_publish(this)"><img src="$!{rc.contextPath}assets/images/click.gif" border="0" title="取消发布" ></a>';
        }

        return diyDom;
    }*/
    function guide_publish(e) {

        var rec = e.record,publish = rec.publish, str = "";
        var disabledStr = Ls.publishStatus(publish);
        if (publish == '1') {
            str = '<button ' + disabledStr + ' type="button" class="btn btn-sm btn-default btn-ok" onclick="cancel_publish('+ rec.id +')" title="取消发布"><span class="glyphicon glyphicon-ok"></span></button>';
        } else {
            str = '<button ' + disabledStr + ' type="button" class="btn btn-sm btn-default btn-remove" onclick="publish('+ rec.id +')" title="发布"><span class="glyphicon glyphicon-ok"></span></button>';

        }

        return str;
    }

    if('$!{toolbar}' != 'hide') {
        //消息回调
        indexMgr.publish = function (d) {
            cur.grid.reload();
        }
    }
    /*
    * 发布
    * ids ： ',' 分割批量发布
    * */
    function publish(id) {
        if (confirm('确定发布?')) {
            Ls.ajaxGet({
                url: "/workGuide/publish",
                data: {
                    ids: id,
                    publish: 1
                },
                success: function (resp) {
                    if (resp.status == 1) {
                        search();
                        Ls.tips("正在生成处理中", {times: 2});
                    } else {
                        Ls.tips(resp.desc, {icons:'error',times: 2});
                    }
                }
            });
        }
    }

    function batchPublish() {

        var records = cur.grid.getSelecteds();

        if (null == records || records.length <= 0) {
            Ls.tips("请选择一条记录!", {times: 2});
            return;
        }

        var ids = [];
        for (var i = 0; i < records.length; i++) {
            ids.push(records[i].id);
        }

        if (confirm('确定发布?')) {
            Ls.ajaxGet({
                url: "/workGuide/publish",
                data: {
                    ids: ids.join(","),
                    publish: 1
                },
                success: function (resp) {
                    if (resp.status == 1) {
                        search();
                        Ls.tips("批量发布成功，正在生成处理中", {times: 2});
                    } else {
                        Ls.tips(resp.desc, {icons:'error',times: 2});
                    }
                }
            });
        }
    }

    /*
    * 取消发布
    * */
    function cancel_publish(id) {
        if (confirm('确定取消发布?')) {
            Ls.ajaxGet({
                url: "/workGuide/publish",
                data: {
                    ids:id,
                    publish: 0
                },
                success: function (resp) {
                    if (resp.status == 1) {
                        search();
                        Ls.tips("正在生成处理中", {times: 2});
                    } else {
                        Ls.tips(resp.desc, {icons:'error',times: 2});
                    }
                }
            });
        }
    }

    function batchCancelPublish() {

        var records = cur.grid.getSelecteds();

        if (null == records || records.length <= 0) {
            Ls.tips("请选择一条记录!", {times: 2});
            return;
        }

        var ids = [];
        for (var i = 0; i < records.length; i++) {
            ids.push(records[i].id);
        }

        if (confirm('确定取消发布?')) {

            Ls.ajaxGet({
                url: "/workGuide/publish",
                data: {
                    ids: ids.join(","),
                    publish: 0
                },
                success: function (resp) {
                    if (resp.status == 1) {
                        search();
                        Ls.tips("批量取消发布成功，正在生成处理中", {times: 2});
                    } else {
                        Ls.tips(resp.desc, {icons:'error',times: 2});
                    }
                }
            });
        }
    }

    function auto_heigth(id, heigth) {
//        var mini = {};
//        mini.id = id
//        Ls.mini_datagrid_height(mini, heigth);
    }

    /*
   * 表格资源选择
   * */
    function table_res_select() {
        art.dialog.data('table_select',cur.record == null?null:cur.record.tableResourcesEOs);
        art.dialog.data('table_select_ids', cur.table_select_lable.attr('value'));
        art.dialog.data('table_select_names', cur.table_select_lable.text());
        art.dialog.data('columnId', content_mgr.indicatorId);
        Ls.openWin("/workGuide/tableSelect", '800px', '450px', {
            title: "选择表格资源库"
        });
    }

    function callback_table_select(ids, names) {
        cur.table_select_lable.text(names);
        cur.table_select_lable.attr('value', ids);
    }


    /*
    * 法规资源选择
    * */
    function rule_res_select() {
        art.dialog.data('rule_select', cur.record == null ? null : cur.record.relatedRuleEOs);
        art.dialog.data('rule_select_ids', cur.rule_select_lable.attr('value'));
        art.dialog.data('rule_select_names', cur.rule_select_lable.text());
        art.dialog.data('columnId', content_mgr.indicatorId);
        Ls.openWin("/workGuide/ruleSelect", '800px', '450px', {
            title: "选择法规"
        });
    }

    function callback_rule_select(ids, names) {
        cur.rule_select_lable.text(names);
        cur.rule_select_lable.attr('value', ids);
    }

    /*
    * 表单重置
    * */
    function form_reset(ids) {
        for (var i = 0; i < ids.length; i++) {
            $("#" + ids[i]).val('');
        }
    }

    /**
     * 资源选择
     */
    function res_select() {
        art.dialog.data('cIds', cur.vm.cIds);
        art.dialog.data('typeCode', '$!{typeCode}');
        art.dialog.data('columnId', content_mgr.indicatorId);
        Ls.openWin("/resources/classifySelect", '650px', '400px', {
            title: "选择资源"
        });
    }

    /**
     * 添加资源返回
     * @param cIds
     * @param cNames
     */
    function res_call_back(cIds, cNames) {
        cur.vm.cIds = cIds;
        cur.vm.cNames = cNames;
        avalon.scan();
    }

    Date.prototype.pattern = function (fmt) {
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours() % 12 == 0 ? 12 : this.getHours() % 12, //小时
            "H+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        var week = {
            "0": "\u65e5",
            "1": "\u4e00",
            "2": "\u4e8c",
            "3": "\u4e09",
            "4": "\u56db",
            "5": "\u4e94",
            "6": "\u516d"
        };
        if (/(y+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        if (/(E+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, ((RegExp.$1.length > 1) ? (RegExp.$1.length > 2 ? "\u661f\u671f" : "\u5468") : "") + week[this.getDay() + ""]);
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            }
        }
        return fmt;
    }
</script>