KindEditor.plugin("table",function(e){function l(e,l){l=l.toUpperCase(),e.css("background-color",l),e.css("color","#000000"===l?"#FFFFFF":"#000000"),e.html(l)}function t(t,o){function a(){e.each(r,function(){this.remove()}),r=[],e(document).unbind("click,mousedown",a),t.unbind("click,mousedown",a)}o.bind("click,mousedown",function(e){e.stopPropagation()}),o.click(function(o){a();var i=e(this),d=i.pos(),c=e.colorpicker({x:d.x,y:d.y+i.height(),z:811214,selectedColor:e(this).html(),colors:n.colorTable,noColor:n.lang("noColor"),shadowMode:n.shadowMode,click:function(e){l(i,e),a()}});r.push(c),e(document).bind("click,mousedown",a),t.bind("click,mousedown",a)})}function o(e,l,t){for(var o=0,n=0,a=l.cells.length;n<a&&l.cells[n]!=t;n++)o+=l.cells[n].rowSpan-1;return t.cellIndex-o}var n=this,a="table",i=n.lang("table."),r=[];n.plugin.table={prop:function(o){var r=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+i.cells+"</label>",i.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',i.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+i.size+"</label>",i.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select> &nbsp; ",i.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+i.space+"</label>",i.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',i.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+i.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+i.alignDefault+"</option>",'<option value="left">'+i.alignLeft+"</option>",'<option value="center">'+i.alignCenter+"</option>",'<option value="right">'+i.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+i.border+"</label>",i.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',i.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+i.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),d=n.cmd.range.createBookmark(),c=n.createDialog({name:a,width:500,title:n.lang(a),body:r,beforeRemove:function(){f.unbind()},yesBtn:{name:n.lang("yes"),click:function(l){var t=s.val(),o=p.val(),a=g.val(),i=v.val(),r=u.val(),c=m.val(),S=h.val(),y=b.val(),C=k.val(),B=w.val(),T=e(f[0]).html()||"",A=e(f[1]).html()||"";if(0==t||!/^\d+$/.test(t))return alert(n.lang("invalidRows")),void s[0].focus();if(0==o||!/^\d+$/.test(o))return alert(n.lang("invalidRows")),void p[0].focus();if(!/^\d*$/.test(a))return alert(n.lang("invalidWidth")),void g[0].focus();if(!/^\d*$/.test(i))return alert(n.lang("invalidHeight")),void v[0].focus();if(!/^\d*$/.test(S))return alert(n.lang("invalidPadding")),void h[0].focus();if(!/^\d*$/.test(y))return alert(n.lang("invalidSpacing")),void b[0].focus();if(!/^\d*$/.test(B))return alert(n.lang("invalidBorder")),void w[0].focus();if(x)return""!==a?x.width(a+r):x.css("width",""),void 0!==x[0].width&&x.removeAttr("width"),""!==i?x.height(i+c):x.css("height",""),void 0!==x[0].height&&x.removeAttr("height"),x.css("background-color",A),void 0!==x[0].bgColor&&x.removeAttr("bgColor"),""!==S?x[0].cellPadding=S:x.removeAttr("cellPadding"),""!==y?x[0].cellSpacing=y:x.removeAttr("cellSpacing"),""!==C?x[0].align=C:x.removeAttr("align"),""!==B?x.attr("border",B):x.removeAttr("border"),""===B||"0"===B?x.addClass("ke-zeroborder"):x.removeClass("ke-zeroborder"),""!==T?x.attr("borderColor",T):x.removeAttr("borderColor"),n.hideDialog().focus(),n.cmd.range.moveToBookmark(d),n.cmd.select(),void n.addBookmark();var I="";""!==a&&(I+="width:"+a+r+";"),""!==i&&(I+="height:"+i+c+";"),""!==A&&(I+="background-color:"+A+";");var R="<table";""!==I&&(R+=' style="'+I+'"'),""!==S&&(R+=' cellpadding="'+S+'"'),""!==y&&(R+=' cellspacing="'+y+'"'),""!==C&&(R+=' align="'+C+'"'),""!==B&&(R+=' border="'+B+'"'),""!==B&&"0"!==B||(R+=' class="ke-zeroborder"'),""!==T&&(R+=' bordercolor="'+T+'"'),R+=">";for(var $=0;$<t;$++){R+="<tr>";for(var q=0;q<o;q++)R+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>";R+="</tr>"}R+="</table>",e.IE||(R+="<br />"),n.insertHtml(R),n.select().hideDialog().focus(),n.addBookmark()}}}).div,s=e('[name="rows"]',c).val(3),p=e('[name="cols"]',c).val(2),g=e('[name="width"]',c).val(100),v=e('[name="height"]',c),u=e('[name="widthType"]',c),m=e('[name="heightType"]',c),h=e('[name="padding"]',c).val(2),b=e('[name="spacing"]',c).val(0),k=e('[name="align"]',c),w=e('[name="border"]',c).val(1),f=e(".ke-input-color",c);t(c,f.eq(0)),t(c,f.eq(1)),l(f.eq(0),"#000000"),l(f.eq(1),""),s[0].focus(),s[0].select();var x;if(!o&&(x=n.plugin.getSelectedTable())){s.val(x[0].rows.length),p.val(x[0].rows.length>0?x[0].rows[0].cells.length:0),s.attr("disabled",!0),p.attr("disabled",!0);var S,y=x[0].style.width||x[0].width,C=x[0].style.height||x[0].height;void 0!==y&&(S=/^(\d+)((?:px|%)*)$/.exec(y))?(g.val(S[1]),u.val(S[2])):g.val(""),void 0!==C&&(S=/^(\d+)((?:px|%)*)$/.exec(C))&&(v.val(S[1]),m.val(S[2])),h.val(x[0].cellPadding||""),b.val(x[0].cellSpacing||""),k.val(x[0].align||""),w.val(void 0===x[0].border?"":x[0].border),l(f.eq(0),e.toHex(x.attr("borderColor")||"")),l(f.eq(1),e.toHex(x[0].style.backgroundColor||x[0].bgColor||"")),g[0].focus(),g[0].select()}},cellprop:function(){var o=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+i.size+"</label>",i.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select> &nbsp; ",i.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+i.percent+"</option>",'<option value="px">'+i.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+i.align+"</label>",i.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+i.alignDefault+"</option>",'<option value="left">'+i.alignLeft+"</option>",'<option value="center">'+i.alignCenter+"</option>",'<option value="right">'+i.alignRight+"</option>","</select> ",i.verticalAlign+' <select name="verticalAlign">','<option value="">'+i.alignDefault+"</option>",'<option value="top">'+i.alignTop+"</option>",'<option value="middle">'+i.alignMiddle+"</option>",'<option value="bottom">'+i.alignBottom+"</option>",'<option value="baseline">'+i.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+i.border+"</label>",i.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',i.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+i.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),r=n.cmd.range.createBookmark(),d=n.createDialog({name:a,width:500,title:n.lang("tablecell"),body:o,beforeRemove:function(){k.unbind()},yesBtn:{name:n.lang("yes"),click:function(l){var t=c.val(),o=s.val(),a=p.val(),i=g.val(),d=(v.val(),u.val(),m.val()),w=h.val(),x=b.val(),S=e(k[0]).html()||"",y=e(k[1]).html()||"";return/^\d*$/.test(t)?/^\d*$/.test(o)?/^\d*$/.test(x)?(f.css({width:""!==t?t+a:"",height:""!==o?o+i:"","background-color":y,"text-align":d,"vertical-align":w,"border-width":x,"border-style":""!==x?"solid":"","border-color":S}),n.hideDialog().focus(),n.cmd.range.moveToBookmark(r),n.cmd.select(),void n.addBookmark()):(alert(n.lang("invalidBorder")),void b[0].focus()):(alert(n.lang("invalidHeight")),void s[0].focus()):(alert(n.lang("invalidWidth")),void c[0].focus())}}}).div,c=e('[name="width"]',d).val(100),s=e('[name="height"]',d),p=e('[name="widthType"]',d),g=e('[name="heightType"]',d),v=e('[name="padding"]',d).val(2),u=e('[name="spacing"]',d).val(0),m=e('[name="textAlign"]',d),h=e('[name="verticalAlign"]',d),b=e('[name="border"]',d).val(1),k=e(".ke-input-color",d);t(d,k.eq(0)),t(d,k.eq(1)),l(k.eq(0),"#000000"),l(k.eq(1),""),c[0].focus(),c[0].select();var w,f=n.plugin.getSelectedCell(),x=f[0].style.width||f[0].width||"",S=f[0].style.height||f[0].height||"";(w=/^(\d+)((?:px|%)*)$/.exec(x))?(c.val(w[1]),p.val(w[2])):c.val(""),(w=/^(\d+)((?:px|%)*)$/.exec(S))&&(s.val(w[1]),g.val(w[2])),m.val(f[0].style.textAlign||""),h.val(f[0].style.verticalAlign||"");var y=f[0].style.borderWidth||"";y&&(y=parseInt(y)),b.val(y),l(k.eq(0),e.toHex(f[0].style.borderColor||"")),l(k.eq(1),e.toHex(f[0].style.backgroundColor||"")),c[0].focus(),c[0].select()},insert:function(){this.prop(!0)},delete:function(){var e=n.plugin.getSelectedTable();n.cmd.range.setStartBefore(e[0]).collapse(!0),n.cmd.select(),e.remove(),n.addBookmark()},colinsert:function(l){var t=n.plugin.getSelectedTable()[0],a=n.plugin.getSelectedRow()[0],i=n.plugin.getSelectedCell()[0],r=i.cellIndex+l;r+=t.rows[0].cells.length-a.cells.length;for(var d=0,c=t.rows.length;d<c;d++){var s=t.rows[d],p=s.insertCell(r);p.innerHTML=e.IE?"":"<br />",r=o(0,s,p)}n.cmd.range.selectNodeContents(i).collapse(!0),n.cmd.select(),n.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(l){var t=n.plugin.getSelectedTable()[0],o=n.plugin.getSelectedRow()[0],a=n.plugin.getSelectedCell()[0],i=o.rowIndex;1===l&&(i=o.rowIndex+(a.rowSpan-1)+l);for(var r=t.insertRow(i),d=0,c=o.cells.length;d<c;d++){o.cells[d].rowSpan>1&&(c-=o.cells[d].rowSpan-1);var s=r.insertCell(d);1===l&&o.cells[d].colSpan>1&&(s.colSpan=o.cells[d].colSpan),s.innerHTML=e.IE?"":"<br />"}for(var p=i;p>=0;p--){var g=t.rows[p].cells;if(g.length>d){for(var v=a.cellIndex;v>=0;v--)g[v].rowSpan>1&&(g[v].rowSpan+=1);break}}n.cmd.range.selectNodeContents(a).collapse(!0),n.cmd.select(),n.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=n.plugin.getSelectedTable()[0],l=n.plugin.getSelectedRow()[0],t=n.plugin.getSelectedCell()[0],o=l.rowIndex+t.rowSpan,a=e.rows[o];if(!(e.rows.length<=o)){var i=t.cellIndex;if(!(a.cells.length<=i)){var r=a.cells[i];t.colSpan===r.colSpan&&(t.rowSpan+=r.rowSpan,a.deleteCell(i),n.cmd.range.selectNodeContents(t).collapse(!0),n.cmd.select(),n.addBookmark())}}},colmerge:function(){n.plugin.getSelectedTable()[0];var e=n.plugin.getSelectedRow()[0],l=n.plugin.getSelectedCell()[0],t=(e.rowIndex,l.cellIndex+1);if(!(e.cells.length<=t)){var o=e.cells[t];l.rowSpan===o.rowSpan&&(l.colSpan+=o.colSpan,e.deleteCell(t),n.cmd.range.selectNodeContents(l).collapse(!0),n.cmd.select(),n.addBookmark())}},rowsplit:function(){var l=n.plugin.getSelectedTable()[0],t=n.plugin.getSelectedRow()[0],a=n.plugin.getSelectedCell()[0],i=t.rowIndex;if(1!==a.rowSpan){for(var r=o(0,t,a),d=1,c=a.rowSpan;d<c;d++){var s=l.rows[i+d],p=s.insertCell(r);a.colSpan>1&&(p.colSpan=a.colSpan),p.innerHTML=e.IE?"":"<br />",r=o(0,s,p)}e(a).removeAttr("rowSpan"),n.cmd.range.selectNodeContents(a).collapse(!0),n.cmd.select(),n.addBookmark()}},colsplit:function(){n.plugin.getSelectedTable()[0];var l=n.plugin.getSelectedRow()[0],t=n.plugin.getSelectedCell()[0],o=t.cellIndex;if(1!==t.colSpan){for(var a=1,i=t.colSpan;a<i;a++){var r=l.insertCell(o+a);t.rowSpan>1&&(r.rowSpan=t.rowSpan),r.innerHTML=e.IE?"":"<br />"}e(t).removeAttr("colSpan"),n.cmd.range.selectNodeContents(t).collapse(!0),n.cmd.select(),n.addBookmark()}},coldelete:function(){for(var l=n.plugin.getSelectedTable()[0],t=n.plugin.getSelectedRow()[0],o=n.plugin.getSelectedCell()[0].cellIndex,a=0,i=l.rows.length;a<i;a++){var r=l.rows[a],d=r.cells[o];d.colSpan>1?(d.colSpan-=1,1===d.colSpan&&e(d).removeAttr("colSpan")):r.deleteCell(o),d.rowSpan>1&&(a+=d.rowSpan-1)}0===t.cells.length?(n.cmd.range.setStartBefore(l).collapse(!0),n.cmd.select(),e(l).remove()):n.cmd.selection(!0),n.addBookmark()},rowdelete:function(){for(var l=n.plugin.getSelectedTable()[0],t=n.plugin.getSelectedRow()[0],o=n.plugin.getSelectedCell()[0],a=t.rowIndex,i=o.rowSpan-1;i>=0;i--)l.deleteRow(a+i);0===l.rows.length?(n.cmd.range.setStartBefore(l).collapse(!0),n.cmd.select(),e(l).remove()):n.cmd.selection(!0),n.addBookmark()}},n.clickToolbar(a,n.plugin.table.prop)});