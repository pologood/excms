KindEditor.plugin("image",function(e){var t=this,i="image",a=e.undef(t.allowImageUpload,!0),l=e.undef(t.allowImageRemote,!0),n=e.undef(t.formatUploadUrl,!0),d=e.undef(t.allowFileManager,!1),o=e.undef(t.isCompress,0),r=e.undef(t.imgWidth,""),g=e.undef(t.imgHeight,""),s=e.undef(t.uploadJson,t.basePath+"php/upload_json.php"),u=e.undef(t.imageTabIndex,0),m=t.pluginsPath+"image/images/",c=e.undef(t.extraFileUploadParams,{}),h=e.undef(t.filePostName,"imgFile"),f=e.undef(t.fillDescAfterUploadImage,!1),p=t.lang("image.");t.plugin.imageDialog=function(a){function l(e,t){H.val(e),P.val(t),E=e,M=t}a.imageUrl,e.undef(a.imageWidth,""),e.undef(a.imageHeight,""),e.undef(a.imageTitle,""),e.undef(a.imageAlign,"");var u=e.undef(a.showRemote,!0),v=e.undef(a.showLocal,!0),b=e.undef(a.tabIndex,0),k=a.clickFn,w="kindeditor_upload_iframe_"+(new Date).getTime(),y=[];for(var x in c)y.push('<input type="hidden" name="'+x+'" value="'+c[x]+'" />');var U,I=['<div style="padding:20px;">','<div class="tabs"></div>','<div class="tab1" style="display:none;">','<div class="ke-dialog-row">','<label for="remoteUrl" style="width:60px;">'+p.remoteUrl+"</label>",'<input type="text" id="remoteUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;',"</div>",'<div class="ke-dialog-row">','<label for="remoteWidth" style="width:60px;">'+p.size+"</label>",p.width+' <input type="text" id="remoteWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> ',p.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> ','<img class="ke-refresh-btn" src="'+m+'refresh.png" width="16" height="16" alt="" style="cursor:pointer;" title="'+p.resetSize+'" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+p.align+"</label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+m+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+m+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+m+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="remoteTitle" style="width:60px;">'+p.imgTitle+"</label>",'<input type="text" id="remoteTitle" class="ke-input-text" name="title" value="" style="width:200px;" />',"</div>","</div>",'<div class="tab2" style="display:none;">','<iframe name="'+w+'" style="display:none;"></iframe>','<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+w+'" action="'+e.addParam(s,"dir=image&isCompress="+o+"&imgWidth="+r+"&imgHeight="+g)+'">','<div class="ke-dialog-row">',y.join(""),'<label style="width:60px;">'+p.localUrl+"</label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+p.upload+'" />',"</div>","</form>","</div>","</div>"].join(""),T=v||d?450:400,D=v&&u?300:250,F=t.createDialog({name:i,width:T,height:D,title:t.lang(i),body:I,yesBtn:{name:t.lang("yes"),click:function(i){if(!F.isLoading){if(v&&u&&U&&0===U.selectedIndex||!u)return""==j.fileBox.val()?void alert(t.lang("pleaseSelectFile")):(F.showLoading(t.lang("uploadLoading")),j.submit(),void L.val(""));var a=e.trim(S.val()),l=H.val(),n=P.val(),d=A.val(),o="";return R.each(function(){if(this.checked)return o=this.value,!1}),"http://"==a||e.invalidUrl(a)?(alert(t.lang("invalidUrl")),void S[0].focus()):/^\d*$/.test(l)?/^\d*$/.test(n)?void k.call(t,a,d,l,n,0,o):(alert(t.lang("invalidHeight")),void P[0].focus()):(alert(t.lang("invalidWidth")),void H[0].focus())}}},beforeRemove:function(){_.unbind(),H.unbind(),P.unbind(),B.unbind()}}),W=F.div,S=e('[name="url"]',W),L=e('[name="localUrl"]',W),_=e('[name="viewServer"]',W),H=e('.tab1 [name="width"]',W),P=e('.tab1 [name="height"]',W),B=e(".ke-refresh-btn",W),A=e('.tab1 [name="title"]',W),R=e('.tab1 [name="align"]',W);u&&v?((U=e.tabs({src:e(".tabs",W),afterSelect:function(e){}})).add({title:p.localImage,panel:e(".tab2",W)}),U.add({title:p.remoteImage,panel:e(".tab1",W)}),U.select(b)):u?e(".tab1",W).show():v&&e(".tab2",W).show();var j=e.uploadbutton({button:e(".ke-upload-button",W)[0],fieldName:h,form:e(".ke-form",W),target:w,width:60,afterUpload:function(a){if(F.hideLoading(),0===a.error){var l=a.url;n&&(l=e.formatUrl(l,"absolute")),t.afterUpload&&t.afterUpload.call(t,l,a,i),f?(e(".ke-dialog-row #remoteUrl",W).val(l),e(".ke-tabs-li",W)[0].click(),e(".ke-refresh-btn",W).click()):k.call(t,l,a.title,a.width,a.height,a.border,a.align,a.originalUrl)}else alert(a.message)},afterError:function(e){F.hideLoading(),t.errorDialog(e)}});j.fileBox.change(function(e){L.val(j.fileBox.val())}),d?_.click(function(i){t.loadPlugin("filemanager",function(){t.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(i,a){t.dialogs.length>1&&(e('[name="url"]',W).val(i),t.afterSelectFile&&t.afterSelectFile.call(t,i),t.hideDialog())}})})}):_.hide();var E=0,M=0;return B.click(function(t){var i=e('<img src="'+S.val()+'" />',document).css({position:"absolute",visibility:"hidden",top:0,left:"-1000px"});i.bind("load",function(){l(i.width(),i.height()),i.remove()}),e(document.body).append(i)}),H.change(function(e){E>0&&P.val(Math.round(M/E*parseInt(this.value,10)))}),P.change(function(e){M>0&&H.val(Math.round(E/M*parseInt(this.value,10)))}),S.val(a.imageUrl),l(a.imageWidth,a.imageHeight),A.val(a.imageTitle),R.each(function(){if(this.value===a.imageAlign)return this.checked=!0,!1}),u&&0===b&&(S[0].focus(),S[0].select()),F},t.plugin.image={edit:function(){var e=t.plugin.getSelectedImage();t.plugin.imageDialog({imageUrl:e?e.attr("data-ke-src"):"http://",imageWidth:e?e.width():"",imageHeight:e?e.height():"",imageTitle:e?e.attr("title"):"",imageAlign:e?e.attr("align"):"",showRemote:l,showLocal:a,tabIndex:e?0:u,clickFn:function(i,a,l,n,d,o,r){t.firstImg&&t.firstImg(i),e?(e.attr("src",i),e.attr("data-ke-src",i),e.attr("data-originalUrl",r),e.attr("width",l),e.attr("height",n),e.attr("title",a),e.attr("align",o),e.attr("alt",a)):t.exec("insertimage",i,a,l,n,d,o,r),setTimeout(function(){t.hideDialog().focus()},0)}})},delete:function(){var e=t.plugin.getSelectedImage();"a"==e.parent().name&&(e=e.parent()),e.remove(),t.addBookmark()}},t.clickToolbar(i,t.plugin.image.edit)});